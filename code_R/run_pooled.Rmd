---
title: "Untitled"
output: html_document
---

set-up

```{r}

# working directory 
setwd("~/BayesWorkflow/code_r")

# packages
pacman::p_load(tidyverse, 
               brms)

```

load data and ensure correct format.

```{r}

# load data
train <- read_csv("../data/train.csv")

# make sure that data format is okay
train <- train %>%
  mutate(idx = as_factor(idx))

```

model-fitting function

```{r}

fit_mod <- function(formula,
                    family,
                    data,
                    prior,
                    sample_prior,
                    file){
  
  b <- brm(
  formula = formula,
  family = family,
  data = data,
  prior = prior,
  cores = 4, chains = 2, 
  sample_prior = sample_prior,
  backend = "cmdstanr",
  file = file,
  file_refit = "on_change",
  threads = threading(2),
  control = list(adapt_delta = .99, # perhaps just .95
                 max_treedepth = 20)
  )
  
  return(b)

}

```

specify formula. 

```{r}

#formula 
f_pooled <- bf(y ~ t) # complete pooling 

```

Get priors and set priors. 

```{r}

# fit the first model
get_prior(formula = f_pooled,
          data = train,
          family = gaussian,
          
)

# set priors: three levels.
prior_pooled_strict <- c(
  prior(normal(0, 0.05), class = b),
  prior(normal(1.5, 0.05), class = Intercept),
  prior(normal(0, 0.05), class = sigma)
)

prior_pooled_reasonable <- c(
  prior(normal(0, 0.5), class = b),
  prior(normal(1.5, 0.5), class = Intercept),
  prior(normal(0, 0.5), class = sigma)
)

prior_pooled_vague <- c(
  prior(normal(0, 5), class = b),
  prior(normal(1.5, 5), class = Intercept),
  prior(normal(0, 5), class = sigma)
)

```

Now we compile models and check prior predictive.

```{r}

# compile the models
m_pooled_strict_prior <- fit_mod(
  formula = f_pooled,
  family = gaussian,
  data = train,
  prior = prior_pooled_strict,
  sample_prior = "only",
  file = "../models_R/m_pooled_strict_prior"
)

m_pooled_reasonable_prior <- fit_mod(
  formula = f_pooled,
  family = gaussian,
  data = train,
  prior = prior_pooled_reasonable,
  sample_prior = "only",
  file = "../models_R/m_pooled_reasonable_prior"
)

m_pooled_vague_prior <- fit_mod(
  formula = f_pooled,
  family = gaussian,
  data = train,
  prior = prior_pooled_vague,
  sample_prior = "only",
  file = "../models_R/m_pooled_vague_prior"
)

```

check the prior predictive checks

```{r}

pp_check(m_pooled_strict_prior, nsamples = 100)
pp_check(m_pooled_reasonable_prior, nsamples = 100)
pp_check(m_pooled_vague_prior, nsamples = 100)

```

fit the models 

```{r}

# fit the models
m_pooled_strict_fit <- fit_mod(
  formula = f_pooled,
  family = gaussian,
  data = train,
  prior = prior_pooled_strict,
  sample_prior = TRUE,
  file = "../models_R/m_pooled_strict_fit"
)

m_pooled_reasonable_fit <- fit_mod(
  formula = f_pooled,
  family = gaussian,
  data = train,
  prior = prior_pooled_reasonable,
  sample_prior = TRUE,
  file = "../models_R/m_pooled_reasonable_fit"
)

m_pooled_vague_fit <- fit_mod(
  formula = f_pooled,
  family = gaussian,
  data = train,
  prior = prior_pooled_vague,
  sample_prior = TRUE,
  file = "../models_R/m_pooled_vague_fit"
)

```

posterior predictive checks 

```{r}

pp_check(m_pooled_strict_fit, nsamples = 100)
pp_check(m_pooled_reasonable_fit, nsamples = 100)
pp_check(m_pooled_vague_fit, nsamples = 100)

```

```{r}

```

